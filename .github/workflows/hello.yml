name: Integration Tests Run
on: push
jobs:
  build:
    services:
      mongo:
        image: mongo
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: example
        ports:
          - 27017:27017
        volumes:
          - ./api/src/main/init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh
      redis:
        image: redis
        options: --health-cmd="redis-cli PING" --health-interval=10s --health-timeout=5s --health-retries=3
        ports:
          - 6379:6379
    env:
      ENVIRONMENT: testing
      DATABASE_NAME: space_testing_db
      MONGO_URI: mongodb://root:example@mongo:27017/space_testing_db?authSource=space_testing_db
      ADMIN_USER: admin
      ADMIN_PASSWORD: 4dm1n
      JWT_EXPIRATION: 1h
      JWT_SECRET: mysecret
      JWT_SALT: r7H9d2Xq8Lp0VzW3
      REDIS_URL: redis://redis:6379
    name: Test
    runs-on: ubuntu-latest
    environment: testing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm i
      - name: Run tests
        run: pnpm run test
